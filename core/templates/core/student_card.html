{% extends 'core/base.html' %}

{% block title %}Карточка: {{ student.first_name }}{% endblock %}

{% block content %}
<style>
    .scrollable-container {
        max-height: 400px; overflow-y: auto; border: 1px solid var(--border);
        border-radius: 12px; background: white;
    }
    .scrollable-container table { width: 100%; border-collapse: collapse; }
    .scrollable-container thead {
        position: sticky; top: 0; background: #f8fafc; z-index: 10; box-shadow: 0 1px 0 var(--border);
    }
    .info-stat-card { padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
    .balance-box { background: #f0fdf4; color: #166534; border: 1px solid #dcfce7; }
    .debt-box { background: #fff1f2; color: #991b1b; border: 1px solid #ffe4e6; }
    .box-label { font-size: 11px; font-weight: 700; opacity: 0.8; text-transform: uppercase; display: block; margin-bottom: 5px; }
    .user-avatar-large {
        width: 70px; height: 70px; background: #e2e8f0; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto 15px; font-size: 28px; color: #64748b; font-weight: 600;
    }
    .badge-hw { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; position: relative; }
    .badge-hw:hover { opacity: 0.8; }
    .status-pending { background: #fef3c7; color: #92400e; }




    /* Цвета статусов ДЗ */
.status-pending { background: #fef3c7; color: #92400e; }    /* Ожидает - Желтый */
.status-submitted { background: #e0f2fe; color: #075985; }  /* На проверке - Голубой */
.status-revision { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; } /* Доработать - Оранжевый */
.status-completed { background: #dcfce7; color: #166534; }  /* Выполнено - Зеленый */

.badge-hw {
    padding: 5px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    transition: all 0.2s;
}

.badge-hw:active { transform: scale(0.95); }
</style>

<div style="display: flex; gap: 25px; align-items: flex-start;">
    <div style="width: 320px; flex-shrink: 0;">
        <div class="card" style="text-align: center; border-top: 5px solid var(--primary);">
            <div class="user-avatar-large">
                {{ student.first_name|slice:":1" }}{{ student.last_name|slice:":1" }}
            </div>
            <h2 style="margin: 0;">{{ student.first_name }} {{ student.last_name }}</h2>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">{{ student.contact|default:"Нет контактов" }}</p>
            <div class="details-container">
                <div class="detail-row">
                    <i class="fas fa-graduation-cap"></i>
                    <span class="detail-label">Класс</span>
                    <span class="detail-value">{{ student.school_class|default:"-" }}</span>
                </div>

                <div class="detail-row">
                    <i class="fas fa-user-friends"></i>
                    <span class="detail-label">Родитель</span>
                    <span class="detail-value">{{ student.parent_name|default:"-" }}</span>
                </div>

                <div class="detail-row">
                    <i class="fas fa-phone-alt"></i>
                    <span class="detail-label">Тел. родителя</span>
                    <span class="detail-value">{{ student.parent_phone|default:"-" }}</span>
                </div>
            </div>

            <div class="info-stat-card balance-box">
                <span class="box-label">Текущий баланс</span>
                <div id="student-balance-val" style="font-size: 24px; font-weight: 800; color: #22c55e;">
                    {{ student.balance }} ₽
                </div>
            </div>

            <div class="info-stat-card debt-box">
                <span class="box-label">К оплате (с учетом баланса)</span>
                <div id="total-debt-val" style="font-size: 20px; font-weight: 700; color: {% if total_debt > 0 %}#ef4444{% else %}#22c55e{% endif %};">
                    {{ total_debt }} ₽
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                <button onclick="openModal('depositModal')" class="btn btn-primary" style="width: 100%;"><i class="fas fa-plus-circle"></i> Пополнить</button>
                <button onclick="openModal('historyModal')" class="btn btn-outline" style="width: 100%;"><i class="fas fa-history"></i> История транзакций</button>
            </div>
        </div>
    </div>

    <div style="flex: 1; display: flex; flex-direction: column; gap: 25px;">
        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0;">Журнал прошедших занятий</h3>
            </div>
            <div class="scrollable-container">
                <table style="width: 100%;">
                    <thead>
                        <tr style="text-align: left; font-size: 12px; color: #64748b;">
                            <th style="padding: 15px;">ДАТА</th>
                            <th>ПРЕДМЕТ</th>
                            <th>СТОИМОСТЬ</th>
                            <th>СТАТУС ОПЛАТЫ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for att in attendances %}
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 15px;">{{ att.lesson.start_time|date:"d.m.Y" }}</td>
                            <td style="font-weight: 600;">{{ att.lesson.subject.name }}</td>
                            <td>{{ att.lesson.price }} ₽</td>
                            <td>
                                <span onclick="togglePay(this, {{ att.id }})" class="pay-dot {% if att.is_paid %}paid{% else %}debt{% endif %}" style="cursor: pointer; padding: 5px 12px; border-radius: 20px; font-size: 11px;">
                                    {% if att.is_paid %}Оплачено{% else %}Долг{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">Домашние задания</h3>
                <button onclick="openModal('homeworkModal')" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Задать ДЗ</button>
            </div>
            <div class="scrollable-container">
                <table style="width: 100%;">
                    <thead>
                        <tr style="text-align: left; font-size: 12px; color: #64748b;">
                            <th style="padding: 15px;">ПРЕДМЕТ</th>
                            <th>ЗАДАНИЕ И ФАЙЛЫ</th>
                            <th>ДЕДЛАЙН</th>
                            <th>СТАТУС</th>
                            <th style="text-align: center; width: 100px;">ДЕЙСТВИЯ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hw in homeworks %}
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 15px;"><strong>{{ hw.subject.name }}</strong></td>
                            <td style="max-width: 300px;">
                                <div style="font-size: 13px; font-weight: 600;">{{ hw.description }}</div>

                                {% if hw.files.exists %}
                                    <div style="margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap;">
                                        {% for f in hw.files.all %}<a href="{{ f.file.url }}" target="_blank" style="font-size: 10px; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; color: var(--primary); text-decoration: none;"><i class="fas fa-paperclip"></i> {{ f.file_name|truncatechars:15 }}</a>{% endfor %}
                                    </div>
                                {% endif %}

                                {% if hw.responses.exists %}
                                    <div style="margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 5px;">
                                        <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px;">Ответы ученика:</div>
                                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                            {% for resp in hw.responses.all %}
                                                <a href="{{ resp.file.url }}" target="_blank" style="font-size: 10px; background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; text-decoration: none; font-weight: 600;">
                                                    <i class="fas fa-reply"></i> {{ resp.file_name|truncatechars:15 }}
                                                </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </td>
                            <td style="font-size: 13px;">{{ hw.deadline|date:"d.m.Y H:i"|default:"---" }}</td>
                            <td>
                                <a href="javascript:void(0);"
                                   onclick="cycleHwStatus({{ hw.id }}, this)"
                                   style="text-decoration: none;"
                                   id="hw-link-{{ hw.id }}">
                                    <span class="badge-hw status-{{ hw.status }}">
                                        {{ hw.get_status_display }}
                                    </span>
                                </a>
                            </td>
                            <td style="text-align: center;">
                                <div style="display: flex; gap: 12px; justify-content: center;">
                                    <button onclick="openEditHWModal('{{ hw.id }}', '{{ hw.subject.id }}', '{{ hw.description|escapejs }}', '{{ hw.deadline|date:'Y-m-d\TH:i' }}', [{% for f in hw.files.all %}{{ f.id }}{% if not forloop.last %},{% endif %}{% endfor %}])"
                                            style="border:none; background:none; color: var(--primary); cursor:pointer;"><i class="fas fa-edit"></i></button>
                                    <a href="{% url 'delete_homework' hw.id %}" onclick="return confirm('Удалить это задание?')" style="color: #ef4444;"><i class="fas fa-trash"></i></a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" style="text-align: center; padding: 30px; color: #94a3b8;">Заданий пока нет</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="depositModal" class="modal-overlay">
    <div class="modal-window" style="max-width: 450px;">
        <div class="close-btn" onclick="closeModal('depositModal')">&times;</div>
        <h2 class="modal-title">Зачислить средства</h2>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="update_balance" value="1">
            <div class="mb-15">
                <label class="form-label">Сумма (₽)</label>
                <input type="number" name="amount" class="filter-select" placeholder="Сумма" required>
            </div>
            <div class="mb-15">
                <label class="form-label">Описание</label>
                <input type="text" name="description" class="filter-select" placeholder="Напр: Перевод Сбербанк">
            </div>
            <div class="mb-20">
                <label class="form-label">Дата и время операции</label>
                <input type="datetime-local" name="date" class="filter-select">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Зачислить</button>
        </form>
    </div>
</div>

<div id="homeworkModal" class="modal-overlay">
    <div class="modal-window" style="max-width: 500px;">
        <div class="close-btn" onclick="closeModal('homeworkModal')">&times;</div>
        <h2 class="modal-title">Новое домашнее задание</h2>
        <form action="{% url 'add_homework' student.id %}" method="post">
            {% csrf_token %}
            <div class="mb-15"><label class="form-label">Предмет</label><select name="subject" class="filter-select" required>{% for sub in subjects %}<option value="{{ sub.id }}">{{ sub.name }}</option>{% endfor %}</select></div>
            <div class="mb-15"><label class="form-label">Описание</label><textarea name="description" class="filter-select" style="height: 100px; padding: 10px;" required placeholder="Напр: Выучить формулы..."></textarea></div>
            <div class="mb-15"><label class="form-label">Срок сдачи</label><input type="datetime-local" name="deadline" class="filter-select"></div>
            <div class="mb-20"><label class="form-label">Материалы</label>
                <div style="max-height: 120px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: #f8fafc;">
                    {% for f in tutor_files %}<label style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer;"><input type="checkbox" name="files" value="{{ f.id }}"><span style="font-size: 13px;">{{ f.file_name }}</span></label>{% endfor %}
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Отправить ученику</button>
        </form>
    </div>
</div>

<div id="editHWModal" class="modal-overlay">
    <div class="modal-window" style="max-width: 500px;">
        <div class="close-btn" onclick="closeModal('editHWModal')">&times;</div>
        <h2 class="modal-title">Редактировать ДЗ</h2>
        <form id="editHWForm" method="post">
            {% csrf_token %}
            <div class="mb-15">
                <label class="form-label">Предмет</label>
                <select name="subject" id="edit-hw-subject" class="filter-select" required>
                    {% for sub in subjects %}<option value="{{ sub.id }}">{{ sub.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="mb-15">
                <label class="form-label">Описание</label>
                <textarea name="description" id="edit-hw-desc" class="filter-select" style="height: 100px; padding: 10px;" required></textarea>
            </div>
            <div class="mb-15">
                <label class="form-label">Срок сдачи</label>
                <input type="datetime-local" name="deadline" id="edit-hw-deadline" class="filter-select">
            </div>
            <div class="mb-15">
                <label class="form-label">Комментарий репетитора</label>
                <textarea name="tutor_comment" id="edit-hw-comment" class="filter-select" style="height: 80px; padding: 10px;" placeholder="Комментарий к заданию..."></textarea>
            </div>
            <div class="mb-20">
                <label class="form-label">Материалы</label>
                <div id="edit-hw-files" style="max-height: 120px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: #f8fafc;">
                    {% for f in tutor_files %}
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" name="files" value="{{ f.id }}" class="edit-hw-file-cb">
                        <span style="font-size: 13px;">{{ f.file_name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Сохранить изменения</button>
        </form>
    </div>
</div>

<div id="historyModal" class="modal-overlay">
    <div class="modal-window" style="max-width: 700px; width: 90%;">
        <div class="close-btn" onclick="closeModal('historyModal')">&times;</div>

        <h2 class="modal-title"><i class="fas fa-history" style="color: var(--primary); margin-right: 10px;"></i> История транзакций</h2>

        <div class="scrollable-container" style="max-height: 450px;">
            <table style="width: 100%;">
                <thead>
                    <tr style="text-align: left; background: #f8fafc; color: #64748b; font-size: 12px;">
                        <th style="padding: 15px;">Дата</th>
                        <th>Описание</th>
                        <th style="text-align: right; padding-right: 20px;">Сумма</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions %}
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 15px; font-size: 13px; color: var(--text-muted);">
                            {{ tx.date|date:"d.m.Y H:i" }} </td>
                        <td style="font-weight: 500;">{{ tx.description|default:"Транзакция" }}</td>
                        <td style="text-align: right; padding-right: 20px; font-weight: 700;">
                            <td style="text-align: right; padding-right: 20px; font-weight: 700;">
                                {% if tx.type == 'deposit' %} <span style="color: #166534;">+{{ tx.amount }} ₽</span>
                                {% else %}
                                    <span style="color: var(--tg-red);">
                                        -{{ tx.amount }} ₽
                                    </span>
                                {% endif %}
                            </td>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" style="text-align: center; padding: 40px; color: #94a3b8;">Истории пока нет</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function openEditHWModal(id, subjectId, desc, deadline, fileIds,comment) {
        const form = document.getElementById('editHWForm');
        form.action = `/homework/edit/${id}/`;
        document.getElementById('edit-hw-subject').value = subjectId;
        document.getElementById('edit-hw-desc').value = desc;
        document.getElementById('edit-hw-deadline').value = deadline || '';
        document.getElementById('edit-hw-comment').value = comment || '';
        const checkboxes = document.querySelectorAll('.edit-hw-file-cb');
        checkboxes.forEach(cb => { cb.checked = fileIds.includes(parseInt(cb.value)); });
        openModal('editHWModal');
    }

    function togglePay(el, attId) {
        fetch(`/toggle-pay/${attId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    el.classList.toggle('paid', data.is_paid);
                    el.classList.toggle('debt', !data.is_paid);
                    el.innerText = data.is_paid ? 'Оплачено' : 'Долг';
                    const balanceEl = document.getElementById('student-balance-val');
                    if (balanceEl) { balanceEl.innerText = data.new_balance + ' ₽'; }
                    const debtEl = document.getElementById('total-debt-val');
                    if (debtEl) {
                        debtEl.innerText = data.new_total_debt + ' ₽';
                        debtEl.style.color = data.new_total_debt > 0 ? '#ef4444' : '#22c55e';
                    }
                } else if (data.status === 'error') { alert(data.message); }
            })
            .catch(err => console.error("Ошибка запроса:", err));
    }

    window.onclick = function(event) { if (event.target.classList.contains('modal-overlay')) { event.target.classList.remove('active'); } }
    function updateHwStatus(hwId, newStatus, selectElement) {
    const formData = new FormData();
    formData.append('status', newStatus);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/homework/edit/${hwId}/`, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
        if (response.ok) {
            // Обновляем цвет самого селекта, меняя его класс
            selectElement.className = `hw-status-select status-${newStatus}`;

            // Визуальный эффект сохранения
            selectElement.style.boxShadow = '0 0 5px var(--tg-active)';
            setTimeout(() => selectElement.style.boxShadow = 'none', 1000);
        }
    })
    .catch(err => console.error("Ошибка:", err));
}

    function cycleHwStatus(hwId, element) {
    const badge = element.querySelector('.badge-hw');

    // Определяем порядок смены статусов (цикл)
    const statusCycle = {
        'pending': { next: 'submitted', label: 'На проверке' },
        'submitted': { next: 'revision', label: 'Доработать' },
        'revision': { next: 'completed', label: 'Выполнено' },
        'completed': { next: 'pending', label: 'Ожидает' }
    };

    // Определяем текущий статус по классу
    let currentStatus = '';
    if (badge.classList.contains('status-pending')) currentStatus = 'pending';
    else if (badge.classList.contains('status-submitted')) currentStatus = 'submitted';
    else if (badge.classList.contains('status-revision')) currentStatus = 'revision';
    else if (badge.classList.contains('status-completed')) currentStatus = 'completed';

    const nextData = statusCycle[currentStatus];

    // Отправляем данные на сервер (используем твой существующий URL редактирования)
    const formData = new FormData();
    formData.append('status', nextData.next);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/homework/edit/${hwId}/`, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => {
        if (response.ok) {
            // Мгновенно обновляем внешний вид пилюли
            badge.className = `badge-hw status-${nextData.next}`;
            badge.innerText = nextData.label;

           
        }
    })
    .catch(err => console.error("Ошибка при смене статуса:", err));
}
</script>
{% endblock %}