{% extends 'mobile/base.html' %}

{% block header_left %}
    <a href="{% url 'index' %}" style="color: white;"><i class="fas fa-chevron-left"></i></a>
{% endblock %}

{% block header_right %}
    <button type="submit" form="lessonForm" style="background:none; border:none; color: var(--tg-blue); font-weight:600; font-size: 16px;">
        Готово
    </button>
{% endblock %}

{% block content %}
<form method="post" id="lessonForm" class="tg-form-container">
    {% csrf_token %}

    <div class="segment-control">
        <div class="segment-option active" onclick="setLessonType('individual', this)">
            Индивидуально
        </div>
        <div class="segment-option" onclick="setLessonType('group', this)">
            Группа
        </div>
        <input type="hidden" name="lesson_type" id="lesson_type_input" value="individual">
    </div>

    <div class="tg-section">
        <div class="tg-input-row" id="field-student">
            <div class="tg-label">Ученик</div>
            <div class="tg-field-wrap">
                {{ form.student }}
            </div>
            <i class="fas fa-chevron-right tg-arrow"></i>
        </div>

        <div class="tg-input-row" id="field-group" style="display: none;">
            <div class="tg-label">Группа</div>
            <div class="tg-field-wrap">
                {{ form.group }}
            </div>
            <i class="fas fa-chevron-right tg-arrow"></i>
        </div>

        <div class="tg-input-row">
            <div class="tg-label">Предмет</div>
            <div class="tg-field-wrap">
                {{ form.subject }}
            </div>
            <i class="fas fa-chevron-right tg-arrow"></i>
        </div>
    </div>

    <div class="tg-section">
        <div class="tg-input-row">
            <div class="tg-label">Начало</div>
            <div class="tg-field-wrap">
                <input type="datetime-local" name="start_time" class="tg-native-input"
                       value="{{ form.start_time.value|date:'Y-m-d\TH:i' }}">
            </div>
        </div>

        <div class="tg-input-row">
            <div class="tg-label">Цена (₽)</div>
            <div class="tg-field-wrap">
                {{ form.price }}
            </div>
        </div>

        <div class="tg-input-row">
            <div class="tg-label">Длит. (мин)</div>
            <div class="tg-field-wrap">
                {{ form.duration }}
            </div>
        </div>
    </div>

    <div class="tg-section">
        <div class="tg-input-row">
            <div class="tg-label">Повторять</div>
            <div class="tg-field-wrap" style="display: flex; justify-content: flex-end;">
                <label class="tg-switch">
                    {{ form.is_recurring }}
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div id="recurring-options" class="recurring-box">
            <div class="weekdays-selector">
                <label class="tg-sublabel">Дни недели</label>
                <div class="days-grid">
                    {% for checkbox in form.weekdays %}
                    <label class="day-checkbox">
                        {{ checkbox.tag }}
                        <span class="day-bubble">{{ checkbox.choice_label }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="tg-input-row no-border">
                <div class="tg-label">Кол-во недель</div>
                <div class="tg-field-wrap">
                    {{ form.repeat_count }}
                </div>
            </div>
        </div>
    </div>

</form>

<style>
    /* --- Стили для формы --- */
    .tg-form-container { padding-top: 20px; padding-bottom: 50px; }

    /* Сегментный переключатель (Tabs) */
    .segment-control {
        display: flex;
        background: #000000;
        margin: 0 15px 20px;
        padding: 2px;
        border-radius: 9px;
        border: 1px solid #333;
    }
    .segment-option {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 13px;
        font-weight: 500;
        color: var(--tg-hint);
        border-radius: 7px;
        cursor: pointer;
        transition: 0.2s;
    }
    .segment-option.active {
        background: #3a3a3c; /* Светлее черного */
        color: white;
        font-weight: 600;
    }

    /* Секции */
    .tg-section {
        background: var(--tg-header); /* #212121 */
        margin-bottom: 30px;
        border-top: 1px solid var(--tg-separator);
        border-bottom: 1px solid var(--tg-separator);
    }

    /* Строки ввода */
    .tg-input-row {
        display: flex; align-items: center;
        margin-left: 15px; padding-right: 15px;
        min-height: 48px;
        border-bottom: 1px solid var(--tg-separator);
        position: relative;
    }
    .tg-input-row:last-child { border-bottom: none; }
    .tg-input-row.no-border { border-bottom: none; margin-left: 0; padding-left: 15px; }

    .tg-label { width: 110px; color: white; font-size: 16px; }

    .tg-field-wrap { flex-grow: 1; display: flex; justify-content: flex-end; }

    /* Стилизация Django инпутов внутри враппера */
    .tg-field-wrap input, .tg-field-wrap select {
        background: transparent; border: none;
        color: var(--tg-blue); font-size: 16px;
        text-align: right; width: 100%; outline: none;
        appearance: none; /* Убираем стандартные стрелки */
    }

    .tg-native-input { color: var(--tg-blue); font-family: inherit; }

    .tg-arrow { color: #555; font-size: 12px; margin-left: 10px; }

    /* iOS Toggle Switch */
    .tg-switch { position: relative; display: inline-block; width: 50px; height: 30px; }
    .tg-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--tg-green); } /* Зеленый iOS */
    input:checked + .slider:before { transform: translateX(20px); }

    /* Блок повторения */
    .recurring-box {
        display: none; /* Скрыто по умолчанию */
        background: #1c1c1c; /* Чуть темнее секции */
        border-top: 1px solid var(--tg-separator);
        padding-bottom: 10px;
    }

    .weekdays-selector { padding: 15px; border-bottom: 1px solid var(--tg-separator); }
    .tg-sublabel { display: block; font-size: 13px; color: var(--tg-hint); margin-bottom: 10px; text-transform: uppercase; }

    .days-grid { display: flex; justify-content: space-between; gap: 5px; }

    /* Дни недели как пузыри */
    .day-checkbox input { display: none; }
    .day-bubble {
        display: flex; align-items: center; justify-content: center;
        width: 36px; height: 36px;
        background: #2b2b2b; color: white;
        border-radius: 50%; font-size: 12px; font-weight: 600;
        transition: 0.2s; border: 1px solid #333;
    }

    .day-checkbox input:checked + .day-bubble {
        background: var(--tg-blue); border-color: var(--tg-blue);
    }

</style>

<script>
    // 1. Логика переключения Индивидуально / Группа
    function setLessonType(type, element) {
        // Меняем стили табов
        document.querySelectorAll('.segment-option').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // Меняем значение скрытого инпута (если он нужен бэкенду)
        document.getElementById('lesson_type_input').value = type;

        // Показываем нужные поля
        const studentRow = document.getElementById('field-student');
        const groupRow = document.getElementById('field-group');

        if (type === 'individual') {
            studentRow.style.display = 'flex';
            groupRow.style.display = 'none';
        } else {
            studentRow.style.display = 'none';
            groupRow.style.display = 'flex';
        }
    }

    // 2. Логика слайдера "Повторение"
    const recurringSwitch = document.querySelector('.tg-switch input');
    const recurringBox = document.getElementById('recurring-options');

    if (recurringSwitch) {
        recurringSwitch.addEventListener('change', function() {
            if (this.checked) {
                // Эффект слайда вниз (простой вариант через display)
                recurringBox.style.display = 'block';
            } else {
                recurringBox.style.display = 'none';
            }
        });

        // Проверка при загрузке (если редактируем урок)
        if (recurringSwitch.checked) {
            recurringBox.style.display = 'block';
        }
    }

    // 3. Маленький хак: добавляем класс всем инпутам Django, чтобы CSS их подцепил
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('#lessonForm input:not([type="checkbox"]):not([type="radio"]), #lessonForm select');
        inputs.forEach(input => {
            // Если у инпута еще нет стилей, можно добавить (хотя CSS выше и так справляется через селекторы)
            input.style.textAlign = 'right';
        });
    });
</script>
{% endblock %}