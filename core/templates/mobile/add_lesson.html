{% extends 'mobile/base.html' %}

{% block header_left %}
    <a href="{% url 'index' %}" style="color: var(--tg-text);"><i class="fas fa-chevron-left"></i></a>
{% endblock %}

{% block header_right %}
    <button type="submit" form="lessonForm" style="background:none; border:none; color: var(--tg-blue); font-weight:600; font-size: 16px; padding: 10px 15px;">
        Готово
    </button>
{% endblock %}

{% block content %}
<form method="post" action="{% url 'add_lesson' %}" id="lessonForm" class="tg-form-container">
    {% csrf_token %}

    <div class="segment-control">
        <div class="segment-option active" onclick="setLessonType('individual', this)">
            Индивидуально
        </div>
        <div class="segment-option" onclick="setLessonType('group', this)">
            Группа
        </div>
        <input type="hidden" name="lesson_type" id="lesson_type_input" value="individual">
    </div>

    <div class="tg-section">
        <div class="tg-input-row" id="field-student">
            <div class="tg-label">Ученик</div>
            <div class="tg-field-wrap">
                {{ form.student }}
            </div>
            <i class="fas fa-chevron-right tg-arrow"></i>
        </div>

        <div class="tg-input-row" id="field-group" style="display: none;">
            <div class="tg-label">Группа</div>
            <div class="tg-field-wrap">
                {{ form.group }}
            </div>
            <i class="fas fa-chevron-right tg-arrow"></i>
        </div>

        <div class="tg-input-row">
            <div class="tg-label">Предмет</div>
            <div class="tg-field-wrap">
                {{ form.subject }}
            </div>
            <i class="fas fa-chevron-right tg-arrow"></i>
        </div>
    </div>

    <div class="tg-section">
        <div class="tg-input-row">
            <div class="tg-label">Начало</div>
            <div class="tg-field-wrap">
                <input type="datetime-local" name="start_time" class="tg-native-input"
                       value="{{ form.start_time.value|date:'Y-m-d\TH:i' }}">
            </div>
        </div>

        <div class="tg-input-row">
            <div class="tg-label">Цена (₽)</div>
            <div class="tg-field-wrap">
                {{ form.price }}
            </div>
        </div>

        <div class="tg-input-row">
            <div class="tg-label">Длит. (мин)</div>
            <div class="tg-field-wrap">
                {{ form.duration }}
            </div>
        </div>
    </div>

    <div class="tg-section">
        <div class="tg-input-row">
            <div class="tg-label">Формат</div>
            <div class="tg-field-wrap">
                {{ form.format }}
            </div>
        </div>

        <div class="tg-input-row">
            <div class="tg-label">Место / Ссылка</div>
            <div class="tg-field-wrap">
                {{ form.location }}
            </div>
        </div>

        <div class="tg-input-row notes-row">
            <div class="tg-label">Заметки</div>
            <div class="tg-field-wrap">
                {{ form.notes }}
            </div>
        </div>
    </div>

    <div class="tg-section">
        <div class="tg-input-row">
            <div class="tg-label">Повторять</div>
            <div class="tg-field-wrap" style="display: flex; justify-content: flex-end;">
                <label class="tg-switch">
                    {{ form.is_recurring }}
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <div id="recurring-options" class="recurring-box">
            <div class="weekdays-selector">
                <label class="tg-sublabel">Дни недели</label>
                <div class="days-grid">
                    {% for checkbox in form.weekdays %}
                    <label class="day-checkbox">
                        {{ checkbox.tag }}
                        <span class="day-bubble">{{ checkbox.choice_label }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="tg-input-row">
                <div class="tg-label">Кол-во недель</div>
                <div class="tg-field-wrap">
                    {{ form.repeat_count }}
                </div>
            </div>

            <div class="recurring-divider">
                <span>или</span>
            </div>

            <div class="tg-input-row no-border">
                <div class="tg-label">До даты</div>
                <div class="tg-field-wrap">
                    <input type="date" name="repeat_until" class="tg-native-input"
                           value="{{ form.repeat_until.value|default:'' }}">
                </div>
            </div>
        </div>
    </div>

    <div style="padding: 20px 15px;">
        <button type="submit" class="mobile-submit-btn">
            <i class="fas fa-check"></i> Создать занятие
        </button>
    </div>
</form>

<style>
    .tg-form-container { padding-top: 20px; padding-bottom: 50px; }

    .segment-control {
        display: flex;
        background: var(--tg-body-bg);
        margin: 0 15px 20px;
        padding: 2px;
        border-radius: 9px;
        border: 1px solid #333;
    }
    .segment-option {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 13px;
        font-weight: 500;
        color: var(--tg-hint);
        border-radius: 7px;
        cursor: pointer;
        transition: 0.2s;
    }
    .segment-option.active {
        background: #3a3a3c;
        color: var(--tg-text);
        font-weight: 600;
    }

    .tg-section {
        background: var(--tg-sidebar);
        margin-bottom: 30px;
        border-top: 1px solid var(--tg-separator);
        border-bottom: 1px solid var(--tg-separator);
    }

    .tg-input-row {
        display: flex; align-items: center;
        margin-left: 15px; padding-right: 15px;
        min-height: 48px;
        border-bottom: 1px solid var(--tg-separator);
        position: relative;
    }
    .tg-input-row:last-child { border-bottom: none; }
    .tg-input-row.no-border { border-bottom: none; margin-left: 0; padding-left: 15px; }

    .tg-label { width: 110px; color: var(--tg-text); font-size: 16px; flex-shrink: 0; }

    .tg-field-wrap { flex-grow: 1; display: flex; justify-content: flex-end; }

    .tg-field-wrap input, .tg-field-wrap select {
        background: transparent; border: none;
        color: var(--tg-blue, #6366f1); font-size: 16px;
        text-align: right; width: 100%; outline: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    .tg-field-wrap select {
        color: #c4b5fd;
        background: transparent;
    }

    .tg-field-wrap select option {
        background: var(--tg-sidebar);
        color: var(--tg-text);
    }

    .tg-field-wrap textarea {
        background: transparent; border: none;
        color: var(--tg-blue, #6366f1); font-size: 14px;
        text-align: right; width: 100%; outline: none;
        resize: none; font-family: inherit;
        min-height: 40px;
    }

    .notes-row { align-items: flex-start; padding-top: 12px; padding-bottom: 12px; }
    .notes-row .tg-label { padding-top: 2px; }

    .tg-native-input { color: var(--tg-blue, #6366f1) !important; font-family: inherit; }

    .tg-arrow { color: #555; font-size: 12px; margin-left: 10px; }

    .tg-switch { position: relative; display: inline-block; width: 50px; height: 30px; }
    .tg-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a3c; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--tg-green); }
    input:checked + .slider:before { transform: translateX(20px); }

    .recurring-box {
        display: none;
        background: #1c1c1c;
        border-top: 1px solid var(--tg-separator);
        padding-bottom: 10px;
    }

    .weekdays-selector { padding: 15px; border-bottom: 1px solid var(--tg-separator); }
    .tg-sublabel { display: block; font-size: 13px; color: var(--tg-hint); margin-bottom: 10px; text-transform: uppercase; }

    .days-grid { display: flex; justify-content: space-between; gap: 5px; }

    .day-checkbox input { display: none; }
    .day-bubble {
        display: flex; align-items: center; justify-content: center;
        width: 36px; height: 36px;
        background: #2b2b2b; color: var(--tg-text);
        border-radius: 50%; font-size: 12px; font-weight: 600;
        transition: 0.2s; border: 1px solid #333;
    }

    .day-checkbox input:checked + .day-bubble {
        background: var(--tg-blue, #6366f1); border-color: var(--tg-blue, #6366f1);
    }

    .recurring-divider {
        text-align: center; padding: 8px 0;
        color: var(--tg-hint); font-size: 13px; font-weight: 600;
    }
    .recurring-divider span {
        background: #1c1c1c; padding: 0 12px;
        position: relative;
    }

    .mobile-submit-btn {
        background: var(--tg-active); color: white; border: none;
        padding: 14px; border-radius: 12px; font-weight: 700; font-size: 15px;
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .mobile-submit-btn:active { opacity: 0.8; }
</style>

<script>
    function setLessonType(type, element) {
        document.querySelectorAll('.segment-option').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('lesson_type_input').value = type;

        const studentRow = document.getElementById('field-student');
        const groupRow = document.getElementById('field-group');

        if (type === 'individual') {
            studentRow.style.display = 'flex';
            groupRow.style.display = 'none';
        } else {
            studentRow.style.display = 'none';
            groupRow.style.display = 'flex';
        }
    }

    const recurringSwitch = document.querySelector('.tg-switch input');
    const recurringBox = document.getElementById('recurring-options');

    if (recurringSwitch) {
        recurringSwitch.addEventListener('change', function() {
            recurringBox.style.display = this.checked ? 'block' : 'none';
        });

        if (recurringSwitch.checked) {
            recurringBox.style.display = 'block';
        }
    }
</script>
{% endblock %}
